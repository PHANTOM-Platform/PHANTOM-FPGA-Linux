# PHANTOM Linux Software Distribution

The PHANTOM Linux software distribution contains prebuilt binaries for the ZC706 board, but also full instructions to create images for other Xilinx-supported boards.

If you are using the ZC706, you only need set up an SD card, copy over the images, and optionally build a root file system.

Note that many of these commands require that the Xilinx tools are in your `$PATH` so ensure that they are correctly installed.

## Installation

To begin, clone the repository.

    git clone https://github.com/PHANTOM-Platform/PHANTOM-FPGA-Linux.git

Before running the build script you will need:
 * [Multistrap](https://wiki.debian.org/Multistrap) (if using the Debian-based file system)
 * [The Device Tree Compiler](https://git.kernel.org/pub/scm/utils/dtc/dtc.git)
 * [mkimage](https://linux.die.net/man/1/mkimage)
 * libssl
 * QEMU
 * Xilinx Vivado tools with Zynq-7000 support (imported into the current environment)

On Debian or Ubuntu-based distributions you can install these with the following command:

	sudo apt-get install multistrap device-tree-compiler u-boot-tools libssl-dev dpkg-dev qemu-user-static

To install the Xilinx tools, consult the documentation that comes with Vivado.

## Quick Start

Before using the script you must tell the tools which target FPGA board you are using by setting the `$TARGET` environment variable. The full list of supported boards is in `boardsupport.sh` but examples are `zc706`, `zybo`, and `zedboard`.

	export TARGET=zc706

First, copy the included pre-built kernel and boot images to be used on the board:

	./make.sh prebuilt

The pre-built images include a BusyBox-based root file system.
If using the Debian-based root file system, set `ROOTFS` to `multistrap` at in `boardsupport.sh` and generate with:

	./make.sh rootfs

The script will ask for root permissions after downloading the packages to allow it to chroot into the new file system in order to change the root password.

_Note: if kernel modules and Open MPI are required in the Debian-based file system, these should be built separately beforehand so they can be copied in._

_Note: if you get unusual errors whilst compiliing, (such as that the compiler is not C and C++ link compatible) ensure that you have sourced Xilinx's setup scripts and that you are therefore compiling using their toolchain._

Now ensure your PHANTOM-compatible IP cores (see later) are in `arch/phantom_ip` and run the following, where `ipcore1` and `ipcore2` are IP cores to build into the project:

	./make.sh hwproject ipcore1 ipcore2
	./make.sh implement

Now create an SD card for the board.

### Set up an SD card (or alternative storage device)

If using the BusyBox-based root file system, the images can be copied directly to flash memory (using a third-party tool), or to a single FAT partition on an SD card, using the instructions below.

If using the Debian-based file system, an SD card (or similar storage) is required to hold the boot images and root file system on separate partitions.

Format an SD card with two partitions:

 * The first, a small FAT32 partition called `BOOT`. This is just to hold the bootloader, kernel, and a bitstream, so 50MB is plenty of space.
 * The rest of the card as an ext4 partition called `Linux`.

Ensure that the SD card partitions are mounted and that the `SDCARD_BOOT` and `SDCARD_ROOTFS` variables at the top of `make.sh` are correctly set. Now copy all the files to the SD card:

	./make.sh sdcard

You are now ready to go!


## PHANTOM-compatible IP Cores

The architecture scripts build an FPGA design from a set of PHANTOM-compatible IP cores in `arch/phantom_ip`. A PHANTOM-compatible IP core has the following characteristics:

 * Exactly one AXI Slave interface, which is used to control the core via UIO-mapped registers.
 * Zero or more AXI Master interfaces which are used for high-speed access to main memory.
 * An optional interrupt line for triggering interrupt handlers in Linux userland.

The IP core should also be an IP core as generated by the Xilinx tools (such as from Vivado HLS or packaged by Vivado).


## Building for other boards

To rebuild the images, the first task is to edit options at the top of `make.sh` to ensure that everything is ready for your target board. The `DEVICETREE`, `UBOOT_TARGET`, and `BOARD_PART` variables are currently set for the ZC706 board.

`DEVICETREE` should be the name of the device tree in the Linux kernel tree to use. Xilinx provides these for all of its boards in the `/arch/arm/boot/dts/` and `/arch/arm64/boot/dts/` folders.

`UBOOT_TARGET` should be the target board to build u-boot for. The available configurations are in the `u-boot-xlnx/configs` directory.

`BOARD_PART` should be the Xilinx name for the target board. You can list all of the board parts that your Xilinx installation supports by entering the command `get_board_parts` into the TCL console of Vivado.

There are examples in `make.sh` itself of what these variables should be set to for other common boards.

`KERNEL_TAG` and `UBOOT_TAG` should be set to the appropriate tag (or branch) name to checkout from the Xilinx repositories. For best compatibility, this should typically match the version of Vivado used to build the hardware. To achieve this, simply set `VIVADO_VERSION` and use the default tag strings. The default version is `2017.2`.

If any extra kernel customisation is needed, configuration parameters can be added to the `/custom/kernel_config` file, whose contents will be appended to the default config (`xilinx_zynq_defconfig`) before the kernel is built.

Once set, grab the kernel and U-Boot sources and build them with the following:

	./make.sh sources
	./make.sh uboot
	./make.sh kernel


## Building Open MPI

[Open MPI](https://www.open-mpi.org) can be downloaded and built for Zynq using the make script, and will be installed to `/opt` on the created root file system by default.

Set the `OMPI_VERSION` variable in `make.sh` as required (the default is to use v3.0.0). If needed, the download URL can also be customised by changing `OMPI_URL`.

Open MPI can then be built and installed with the following:

	./make.sh sources
	./make.sh ompi


## Creating an FPGA hardware design

The PHANTOM distribution also contains the scripts which create PHANTOM-compatible FPGA designs. A PHANTOM hardware design encapsulates a set of IP cores, makes them available to the software running in the Linux distribution, and includes the various security and monitoring requirements of the PHANTOM platform.

To build a hardware project, first check ensure that the IP cores you are using are in the `arch/phantom_ip` directory. This directory already contains two dummy IP cores which can be used for testing. Ensure that the `BOARD_PART` option at the top of `make.sh` is set for your target board. `BOARD_PART` is the Xilinx part name for the development board being used. For the ZC706 this is `xilinx.com:zc706:part0:1.3`. You can list all of the board parts that your Xilinx installation supports by entering the command `get_board_parts` into the TCL console of Vivado.

Once set, execute the following:

	./make.sh hwproject ipcore1 ipcore2

where `ipcore1` and `ipcore2` are the PHANTOM IP cores to add to this project. This will create a Vivado project at `/hwproject` which you can build using Vivado as normal, or implement from the command line with:

	./make.sh implement


## Note on Device Trees

You must have a suitable device tree for the kernel to work on your target board. Xilinx's repository contains device trees for many boards in the `/arch/arm/boot/dts/` and `/arch/arm64/boot/dts/` folders. These all include a base tree called `zynq-7000.dtsi` which describes the generic Zynq SoC architecture. This project includes a customised `zynq-7000.dtsi`, the only difference being that the customised version includes the file `arch/phantom_uio_devices.dtsi` to inform the kernel about the PHANTOM architecture infrastructure. This is all handled by `./make.sh`.

If your target board requires an entirely custom device tree that is not included in the Xilinx repository, ensure that it includes the line:

	#include "phantom_uio_devices.dtsi"

Then compile your device tree to a `.dtb` file called `images/devicetree.dtb` before running `./make.sh sdcard`.


## Generate an FSBL

An FSBL (first stage bootloader) is required to start the boot process. The `images` folder contains a prebuilt FSBL for the ZC706.

You can generate a new FSBL based on the current hardware design, using:

	./make.sh fsbl

This will create `images/fsbl.elf`. Alternatively, an FSBL can be created using Xilinx SDK.


## Create a boot image

We now need to combine the FSBL and U-Boot into a single boot image. The `images` folder contains a prebuilt `BOOT.bin` containing the bootloaders generated for the ZC706.

If the FSBL or U-Boot executables are changed, the boot image can be recreated using:

	./make.sh bootimage

This will create `images/BOOT.bin`. Alternatively, a boot image can be created using Xilinx SDK.


## Creating a root file system

The make script can create either a [Debian](https://www.debian.org)-based root file system using [Multistrap](https://wiki.debian.org/Multistrap), or a [BusyBox](https://busybox.net)-based root file system using [Buildroot](https://buildroot.org). The Debian file system is designed to be mounted as the system's main persistent storage (e.g. from an SD card), whereas the BusyBox system is better suited to running as an ephemeral RAM disk.

The file system can be generated by setting the `ROOTFS` variable in `make.sh` to either `multistrap` or `buildroot`, then running:

	./make.sh rootfs

If the appropriate sources have been downloaded and built beforehand, this will also copy Open MPI, Linux kernel modules and the PHANTOM API libraries into the file system.

Alternative Linux file systems can be used, but are not supported by these scripts.

### Buildroot file system customisation

The Buildroot-generated file system can be modified using the configuration file, post-build script and file system overlay in the [`buildroot-phantom`](buildroot-phantom) folder.

More information is available in the [Buildroot manual](https://buildroot.org/downloads/manual/manual.html).

### Multistrap file system customisation

The basic contents of the file system can be customised by editing [`multistrap/multistrap.conf`](multistrap/multistrap.conf) before building. This file defines the packages included, as well as the Debian version to use (both Jessie and Stretch should work). The default configuration uses Debian Jessie, and includes a selection of useful packages for a fairly full-featured system.

The [`multistrap/rootfs_setup.sh`](multistrap/rootfs_setup.sh) script is run to set-up the Multistrap system after packages have been downloaded. This file can be modified to customise this process.

Additional files can be added to the root file system automatically by the make script by placing them in the [`multistrap/overlay/`](multistrap/overlay/) folder.

### File system size

The Debian root file system created by the scripts is designed to be copied to an SD card and mounted as the system's main storage, so can be quite large.

The following are estimated sizes for the built file system, where 'complete' is the full PHANTOM default `multistrap.conf` and 'minimal' is only the base Debian packages required for booting:

* Jessie (complete) - 388MB
* Jessie (minimal) - 186MB
* Stretch (complete) - 395MB
* Stretch (minimal) - 169MB

This includes around 13MB for Open MPI, kernel modules and the PHANTOM API on top of the Debian system.

The compressed image of the BusyBox file system is around 10MB by default (with Open MPI, kernel modules and PHANTOM API included).


## Supporting files for additional boards, etc.

The [`support/`](support/) folder contains a range of additional files that can be installed for working with non-standard boards, as well as potential kernel patches and configuration options.

See the [support README file](support/README.md) for more information.


## Running a full build from sources

The following series of make script commands will run a typical full build and install of all components from sources.

The variables at the top of the make script should be set before starting the build process, and the SD card partitioned and mounted ready for use.

If any kernel, U-Boot or Buildroot customisations are required (patches, overlays, etc.), these should be applied after fetching sources and before building these components.

	./make.sh sources
	./make.sh hwproject phantom_dummy_2
	./make.sh implement
	./make.sh fsbl
	./make.sh uboot
	./make.sh bootimage
	./make.sh kernel
	./make.sh ompi
	./make.sh rootfs
	./make.sh sdcard
